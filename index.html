<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChefAI - ××©×›×¤×œ ×”××ª×›×•× ×™× ×”×—×–×•×ª×™</title>
    <style>
        /* 
         ========================================
         CORE CSS VARIABLES & THEME CONFIGURATION
         ========================================
        */
        :root {
            /* Palette - Primary */
            --primary-hue: 22; /* Orange/Food color */
            --primary-50: hsl(var(--primary-hue), 100%, 95%);
            --primary-100: hsl(var(--primary-hue), 100%, 90%);
            --primary-200: hsl(var(--primary-hue), 100%, 80%);
            --primary-300: hsl(var(--primary-hue), 100%, 70%);
            --primary-400: hsl(var(--primary-hue), 100%, 60%);
            --primary-500: hsl(var(--primary-hue), 100%, 50%);
            --primary-600: hsl(var(--primary-hue), 100%, 45%);
            --primary-700: hsl(var(--primary-hue), 100%, 35%);
            
            /* Palette - Neutral */
            --slate-50: #f8fafc;
            --slate-100: #f1f5f9;
            --slate-200: #e2e8f0;
            --slate-300: #cbd5e1;
            --slate-400: #94a3b8;
            --slate-500: #64748b;
            --slate-600: #475569;
            --slate-700: #334155;
            --slate-800: #1e293b;
            --slate-900: #0f172a;

            /* Semantic Colors */
            --bg-body: var(--slate-50);
            --bg-card: #ffffff;
            --text-main: var(--slate-900);
            --text-muted: var(--slate-500);
            --border-color: var(--slate-200);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-md: 0.5rem;
            --radius-lg: 1rem;
            --radius-full: 9999px;

            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-smooth: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Dark Mode Override */
        [data-theme="dark"] {
            --bg-body: var(--slate-900);
            --bg-card: var(--slate-800);
            --text-main: var(--slate-50);
            --text-muted: var(--slate-400);
            --border-color: var(--slate-700);
            --primary-500: hsl(var(--primary-hue), 100%, 60%);
        }

        /* 
         ========================================
         RESET & BASE STYLES
         ========================================
        */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            transition: background-color var(--transition-smooth), color var(--transition-smooth);
            overflow-x: hidden;
            min-height: 100vh;
        }

        img, svg, video {
            display: block;
            max-width: 100%;
        }

        button {
            cursor: pointer;
            border: none;
            background: none;
            font-family: inherit;
        }

        /* 
         ========================================
         LAYOUT UTILITIES
         ========================================
        */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-6 { gap: 1.5rem; }
        .grid { display: grid; }
        .grid-cols-1 { grid-template-columns: repeat(1, 1fr); }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .hidden { display: none !important; }

        @media (min-width: 768px) {
            .md\:grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
            .md\:grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        }

        /* 
         ========================================
         COMPONENTS: HEADER & NAVIGATION
         ========================================
        */
        header {
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1rem 0;
            box-shadow: var(--shadow-sm);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-500);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            border-radius: var(--radius-md);
            color: var(--text-muted);
            transition: var(--transition-fast);
        }

        .btn-icon:hover {
            background-color: var(--slate-100);
            color: var(--text-main);
        }

        [data-theme="dark"] .btn-icon:hover {
            background-color: var(--slate-700);
        }

        /* 
         ========================================
         COMPONENTS: UPLOAD AREA
         ========================================
        */
        .upload-section {
            padding: 3rem 0;
            text-align: center;
        }

        .drop-zone {
            background-color: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-lg);
            padding: 4rem 2rem;
            transition: var(--transition-smooth);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: var(--primary-500);
            background-color: var(--primary-50);
        }
        
        [data-theme="dark"] .drop-zone:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            color: var(--primary-400);
        }

        .preview-image {
            max-height: 400px;
            border-radius: var(--radius-md);
            margin: 2rem auto;
            box-shadow: var(--shadow-lg);
            object-fit: contain;
        }

        /* 
         ========================================
         COMPONENTS: BUTTONS & INPUTS
         ========================================
        */
        .btn-primary {
            background-color: var(--primary-500);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius-full);
            font-weight: 600;
            transition: var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
        }

        .btn-primary:hover {
            background-color: var(--primary-600);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background-color: var(--slate-300);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .input-group {
            margin-bottom: 1rem;
            text-align: right;
        }

        .input-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .text-input, .select-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 1rem;
        }

        /* 
         ========================================
         COMPONENTS: RECIPE DISPLAY
         ========================================
        */
        .recipe-container {
            margin-top: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .recipe-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .recipe-title {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.2;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .meta-tags {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .tag {
            background-color: var(--slate-100);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--slate-600);
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        [data-theme="dark"] .tag {
            background-color: var(--slate-700);
            color: var(--slate-300);
        }

        .recipe-card {
            background-color: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-100);
            color: var(--primary-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Ingredients Checklist */
        .ingredient-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .ingredient-item:last-child { border-bottom: none; }

        .checkbox-custom {
            width: 20px;
            height: 20px;
            border: 2px solid var(--slate-300);
            border-radius: 4px;
            margin-left: 1rem;
            cursor: pointer;
            position: relative;
        }

        .checkbox-custom.checked {
            background-color: var(--primary-500);
            border-color: var(--primary-500);
        }

        .checkbox-custom.checked::after {
            content: 'âœ“';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
        }

        /* Cooking Steps */
        .step-card {
            background-color: var(--bg-body);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
            border-right: 4px solid var(--primary-300);
            transition: var(--transition-fast);
        }

        .step-card:hover {
            border-right-color: var(--primary-500);
            transform: translateX(-5px);
        }

        .step-number {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: var(--primary-500);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: var(--shadow-sm);
        }

        .visual-cue {
            background-color: rgba(249, 115, 22, 0.1); /* Primary with opacity */
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-top: 1rem;
            font-size: 0.9rem;
            border-right: 3px solid var(--primary-500);
            display: flex;
            gap: 0.5rem;
        }

        /* 
         ========================================
         COMPONENTS: LOADERS & ANIMATIONS
         ========================================
        */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        [data-theme="dark"] .loading-overlay {
            background-color: rgba(15, 23, 42, 0.9);
        }

        .chef-hat-anim {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            animation: bounce 1s infinite alternate;
        }

        .loader-text {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-600);
            animation: pulse 1.5s infinite;
        }

        .progress-bar-container {
            width: 300px;
            height: 8px;
            background-color: var(--slate-200);
            border-radius: var(--radius-full);
            margin-top: 1rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-500);
            width: 0%;
            transition: width 0.3s ease;
        }

        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-20px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 
         ========================================
         COMPONENTS: MODALS
         ========================================
        */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-backdrop.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--bg-card);
            padding: 2rem;
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }

        /* 
         ========================================
         COOK MODE (FULL SCREEN OVERLAY)
         ========================================
        */
        .cook-mode-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-body);
            z-index: 300;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .cook-step-large {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            margin: auto 0;
        }

        .cook-controls {
            display: flex;
            justify-content: center;
            gap: 2rem;
            padding: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .timer-display {
            font-family: monospace;
            font-size: 3rem;
            font-weight: bold;
            color: var(--primary-500);
            text-align: center;
            margin: 1rem 0;
        }

    </style>
</head>
<body>

    <!-- 
    ========================================
    HEADER UI
    ========================================
    -->
    <header>
        <div class="container flex justify-between items-center">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 2a5 5 0 0 1 5 5v2a5 5 0 0 1-10 0V7a5 5 0 0 1 5-5z"></path>
                    <path d="M10 15v5"></path>
                    <path d="M14 15v5"></path>
                    <path d="M4 11v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
                </svg>
                ChefAI
            </div>
            <div class="flex gap-2">
                <button class="btn-icon" id="theme-toggle" title="×”×—×œ×£ ×¢×¨×›×ª × ×•×©×">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="btn-icon" id="history-btn" title="×”×™×¡×˜×•×¨×™×™×ª ××ª×›×•× ×™×">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                </button>
                <button class="btn-icon" id="settings-btn" title="×”×’×“×¨×•×ª API">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- 
    ========================================
    MAIN CONTENT
    ========================================
    -->
    <main class="container">
        
        <!-- Welcome & Upload Section -->
        <section id="upload-view" class="upload-section">
            <h1 style="font-size: 3rem; margin-bottom: 1rem; color: var(--primary-600);">××” × ×‘×©×œ ×”×™×•×?</h1>
            <p style="font-size: 1.2rem; color: var(--text-muted); margin-bottom: 2rem;">
                ×”×¢×œ×” ×ª××•× ×” ×©×œ ×›×œ ×× ×” ×©×ª×¨×¦×”, ×•×× ×™ ××¦×•×¨ ×¢×‘×•×¨×š ××ª ×”××ª×›×•×Ÿ ×”××•×©×œ× ×¢× ×”×•×¨××•×ª ×¢×™×¦×•×‘ ××“×•×™×§×•×ª.
            </p>

            <div class="drop-zone" id="drop-zone">
                <div id="drop-content">
                    <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                    <h3>×’×¨×•×¨ ×ª××•× ×” ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</h3>
                    <p class="text-muted" style="margin-top: 0.5rem">×ª×•××š JPG, PNG, WEBP</p>
                </div>
                <img id="image-preview" class="preview-image hidden" alt="×ª×¦×•×’×” ××§×“×™××”" />
                <input type="file" id="file-input" accept="image/*" class="hidden">
            </div>

            <!-- Pre-generation Options -->
            <div id="options-panel" class="hidden" style="margin-top: 2rem; text-align: right; max-width: 600px; margin-left: auto; margin-right: auto;">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="input-group">
                        <label class="input-label">××’×‘×œ×•×ª ×ª×–×•× ×”</label>
                        <select id="dietary-select" class="select-input">
                            <option value="none">×œ×œ× ×”×’×‘×œ×”</option>
                            <option value="vegan">×˜×‘×¢×•× ×™</option>
                            <option value="vegetarian">×¦××—×•× ×™</option>
                            <option value="gluten_free">×œ×œ× ×’×œ×•×˜×Ÿ</option>
                            <option value="kosher">×›×©×¨</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label class="input-label">×©×¤×”</label>
                        <select id="language-select" class="select-input">
                            <option value="hebrew">×¢×‘×¨×™×ª</option>
                            <option value="english">English</option>
                            <option value="russian">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                            <option value="arabic">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label class="input-label">×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ×©×£ (××•×¤×¦×™×•× ×œ×™)</label>
                    <input type="text" id="extra-notes" class="text-input" placeholder="×œ××©×œ: ×ª×¢×©×” ××ª ×–×” ×¤×—×•×ª ×—×¨×™×£...">
                </div>
                
                <div class="flex justify-center" style="margin-top: 2rem;">
                    <button id="generate-btn" class="btn-primary" style="font-size: 1.2rem; padding: 1rem 3rem;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                        </svg>
                        ×¦×•×¨ ××ª×›×•×Ÿ ×§×¡×•×
                    </button>
                    <button id="reset-image-btn" style="margin-right: 1rem; color: var(--text-muted); text-decoration: underline;">
                        ×‘×—×¨ ×ª××•× ×” ××—×¨×ª
                    </button>
                </div>
            </div>
        </section>

        <!-- Result View (Hidden initially) -->
        <section id="recipe-view" class="recipe-container hidden">
            <!-- Toolbar -->
            <div class="flex justify-between items-center" style="margin-bottom: 1rem;">
                <button id="back-to-upload" class="btn-icon">
                    â† ×—×–×¨×”
                </button>
                <div class="flex gap-2">
                    <button class="btn-primary" id="start-cooking-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polygon points="10 8 16 12 10 16 10 8"></polygon>
                        </svg>
                        ××¦×‘ ×‘×™×©×•×œ
                    </button>
                    <button class="btn-icon" id="print-btn" title="×”×“×¤×¡">ğŸ–¨ï¸</button>
                    <button class="btn-icon" id="speak-btn" title="×”×§×¨× ××ª×›×•×Ÿ">ğŸ”Š</button>
                </div>
            </div>

            <!-- Dynamic Content gets injected here -->
            <div id="recipe-content-area"></div>
        </section>

    </main>

    <!-- 
    ========================================
    MODALS & OVERLAYS
    ========================================
    -->

    <!-- Loading Screen -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="chef-hat-anim">
            <svg viewBox="0 0 512 512" width="100%" height="100%" fill="var(--primary-500)">
                <path d="M464,192c-15.8,0-30.4,5.4-42.1,14.4c-12.7-27.4-40.6-46.4-73.9-46.4c-1.3,0-2.6,0.1-3.9,0.2c-12-35.3-45.7-60.2-85.1-60.2 c-39.4,0-73.1,24.9-85.1,60.2c-1.3-0.1-2.6-0.2-3.9-0.2c-33.3,0-61.2,19-73.9,46.4C82.4,197.4,67.8,192,52,192C23.3,192,0,215.3,0,244 c0,27.1,20.8,49.4,47.2,51.6l19.5,108.9C71.3,429.6,92.5,448,117.8,448h280.4c25.3,0,46.5-18.4,51.1-43.5l19.5-108.9 C495.2,293.4,516,271.1,516,244C516,215.3,492.7,192,464,192z"/>
            </svg>
        </div>
        <div class="loader-text" id="loader-text">×”-AI ×× ×ª×— ××ª ×”××¨×›×™×‘×™×...</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="settings-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem">
                <h2 style="font-size: 1.5rem">×”×’×“×¨×•×ª API</h2>
                <button class="close-modal btn-icon">âœ•</button>
            </div>
            <p style="margin-bottom: 1rem; color: var(--text-muted)">
                ×›×“×™ ×œ×”×©×ª××© ×‘××¤×œ×™×§×¦×™×”, ×¢×œ×™×š ×œ×”×›× ×™×¡ ××¤×ª×— API ×©×œ Google Gemini. ×”××¤×ª×— × ×©××¨ ×‘×“×¤×“×¤×Ÿ ×©×œ×š ×‘×œ×‘×“.
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--primary-500)">×”×©×’ ××¤×ª×— ×›××Ÿ</a>.
            </p>
            <div class="input-group">
                <label class="input-label">Gemini API Key</label>
                <input type="password" id="api-key-input" class="text-input" placeholder="AIzaSy...">
            </div>
            <button id="save-api-key" class="btn-primary" style="width: 100%">×©××•×¨ ×•×”××©×š</button>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center" style="margin-bottom: 1.5rem">
                <h2 style="font-size: 1.5rem">×”×™×¡×˜×•×¨×™×™×ª ××ª×›×•× ×™×</h2>
                <button class="close-modal btn-icon">âœ•</button>
            </div>
            <div id="history-list" style="max-height: 400px; overflow-y: auto;">
                <!-- History items injected here -->
            </div>
            <button id="clear-history" style="width: 100%; margin-top: 1rem; color: #ef4444; padding: 0.5rem; border: 1px solid #ef4444; border-radius: var(--radius-md)">× ×§×” ×”×™×¡×˜×•×¨×™×”</button>
        </div>
    </div>

    <!-- Cook Mode Overlay -->
    <div id="cook-mode-view" class="cook-mode-overlay hidden">
        <div class="flex justify-between items-center">
            <h2 id="cook-mode-title">×‘×™×©×•×œ ×¤×¢×™×œ</h2>
            <button id="exit-cook-mode" class="btn-icon" style="background: var(--slate-200)">âœ• ×™×¦×™××”</button>
        </div>
        
        <div id="cook-step-container" class="flex-col" style="flex: 1; justify-content: center; align-items: center; padding: 2rem;">
            <!-- Dynamic Step Content -->
        </div>

        <div class="cook-controls">
            <button id="prev-step" class="btn-icon" style="font-size: 2rem; padding: 1rem;">â†</button>
            <div style="text-align: center">
                <span id="step-indicator" style="font-size: 1.2rem; display: block;">×¦×¢×“ 1 ××ª×•×š 5</span>
                <button id="cook-timer-btn" class="btn-primary" style="margin-top: 1rem;">â±ï¸ ×”×¤×¢×œ ×˜×™×™××¨ (5 ×“×§')</button>
                <div id="active-timer" class="timer-display hidden">05:00</div>
            </div>
            <button id="next-step" class="btn-icon" style="font-size: 2rem; padding: 1rem;">â†’</button>
        </div>
    </div>

    <!-- 
    ========================================
    JAVASCRIPT LOGIC
    ========================================
    -->
    <script>
        /**
         * APPLICATION ARCHITECTURE
         * 1. Utils: Helper functions (Storage, formatting).
         * 2. State: Global application state.
         * 3. GeminiAPI: Handles communication with Google AI.
         * 4. RecipeEngine: Parses and processes recipe data.
         * 5. UI: DOM manipulation and rendering.
         * 6. VoiceAssistant: Text-to-Speech handling.
         */

        /* --- 1. UTILS --- */
        const Utils = {
            $: (selector) => document.querySelector(selector),
            $$: (selector) => document.querySelectorAll(selector),
            
            saveLocal: (key, data) => {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                } catch (e) { console.error("Storage Error", e); }
            },
            
            getLocal: (key) => {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) { return null; }
            },

            fileToBase64: (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Get only Base64 part
                reader.onerror = error => reject(error);
            }),

            resizeImage: (file, maxWidth = 800) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                            
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.8)); // Return compressed data URL
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            },

            sanitize: (str) => {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        };

        /* --- 2. STATE --- */
        const State = {
            apiKey: Utils.getLocal('gemini_api_key') || '',
            currentImageBase64: null,
            currentRecipe: null,
            history: Utils.getLocal('recipe_history') || [],
            theme: Utils.getLocal('theme') || 'light',
            currentStepIndex: 0,
            timerInterval: null
        };

        /* --- 3. GEMINI API CLIENT --- */
        class GeminiClient {
            constructor() {
                this.baseUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
            }

            async generateRecipe(imageBase64, options) {
                if (!State.apiKey) throw new Error("×—×¡×¨ ××¤×ª×— API");

                const promptText = `
                    You are a world-class professional chef and food stylist.
                    Analyze this image carefully. I want to recreate this dish EXACTLY as it looks in the photo.
                    
                    Identify:
                    1. The exact name of the dish.
                    2. The ingredients (estimate quantities).
                    3. The preparation steps.
                    4. CRITICAL: Visual Styling Instructions. Explain how to plate/arrange the food to match the image visually (e.g., "sprinkle parsley on the left", "stack the pancakes", "sauce drizzle pattern").

                    User Constraints:
                    - Dietary: ${options.dietary}
                    - Language: ${options.language}
                    - Extra Notes: ${options.notes}

                    OUTPUT FORMAT: JSON ONLY. Do not include markdown code blocks like \`\`\`json. Just the raw JSON object.
                    
                    JSON Structure:
                    {
                        "title": "String",
                        "description": "String",
                        "prep_time": "String (e.g., 20 ×“×§×•×ª)",
                        "cook_time": "String",
                        "difficulty": "String (×§×œ/×‘×™× ×•× ×™/×§×©×”)",
                        "servings": "Number",
                        "ingredients": [
                            { "item": "String (name)", "amount": "String (qty + unit)", "category": "String (optional)" }
                        ],
                        "steps": [
                            { 
                                "instruction": "String (detailed cooking action)", 
                                "visual_tip": "String (Optional: specific tip to make it look like the photo)",
                                "timer_seconds": Number (optional, if a timer is needed, e.g., 300 for 5 mins)
                            }
                        ],
                        "styling_guide": {
                            "summary": "String (General plating philosophy for this dish)",
                            "key_elements": ["String", "String"]
                        }
                    }
                `;

                const payload = {
                    contents: [{
                        parts: [
                            { text: promptText },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: imageBase64
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.4, // Lower temp for more accurate structured output
                        maxOutputTokens: 4000
                    }
                };

                try {
                    const response = await fetch(`${this.baseUrl}?key=${State.apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || 'API Error');
                    }

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    
                    // Clean up markdown block if present
                    const cleanText = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleanText);

                } catch (error) {
                    console.error("Gemini Error:", error);
                    throw error;
                }
            }
        }

        /* --- 4. VOICE ASSISTANT --- */
        class VoiceAssistant {
            constructor() {
                this.synth = window.speechSynthesis;
                this.speaking = false;
            }

            speak(text, lang = 'he-IL') {
                if (this.synth.speaking) {
                    this.synth.cancel();
                    this.speaking = false;
                    return; // Toggle off
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang;
                utterance.rate = 1;
                utterance.pitch = 1;
                
                this.synth.speak(utterance);
                this.speaking = true;
            }

            stop() {
                this.synth.cancel();
                this.speaking = false;
            }
        }

        /* --- 5. UI MANAGER --- */
        const UI = {
            init: () => {
                UI.applyTheme();
                UI.setupEventListeners();
                UI.checkApiKey();
                UI.renderHistory();
            },

            applyTheme: () => {
                document.documentElement.setAttribute('data-theme', State.theme);
            },

            toggleTheme: () => {
                State.theme = State.theme === 'light' ? 'dark' : 'light';
                Utils.saveLocal('theme', State.theme);
                UI.applyTheme();
            },

            checkApiKey: () => {
                if (!State.apiKey) {
                    Utils.$('#settings-modal').classList.add('active');
                } else {
                    Utils.$('#api-key-input').value = State.apiKey;
                }
            },

            showLoader: (show, text = '××¢×‘×“...') => {
                const loader = Utils.$('#loading-overlay');
                const progressBar = Utils.$('#progress-bar');
                const loaderText = Utils.$('#loader-text');
                
                if (show) {
                    loader.classList.remove('hidden');
                    loaderText.textContent = text;
                    progressBar.style.width = '0%';
                    // Simulated progress
                    setTimeout(() => progressBar.style.width = '30%', 500);
                    setTimeout(() => progressBar.style.width = '70%', 2000);
                    setTimeout(() => progressBar.style.width = '90%', 4000);
                } else {
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        loader.classList.add('hidden');
                        progressBar.style.width = '0%';
                    }, 300);
                }
            },

            renderRecipe: (recipe) => {
                const container = Utils.$('#recipe-content-area');
                
                // Ingredients HTML
                const ingredientsHtml = recipe.ingredients.map(ing => `
                    <div class="ingredient-item">
                        <div class="checkbox-custom" onclick="this.classList.toggle('checked')"></div>
                        <span style="margin-right: 10px; font-weight: 500;">${Utils.sanitize(ing.amount)}</span>
                        <span>${Utils.sanitize(ing.item)}</span>
                    </div>
                `).join('');

                // Steps HTML with Styling tips
                const stepsHtml = recipe.steps.map((step, index) => `
                    <div class="step-card">
                        <div class="step-number">${index + 1}</div>
                        <p>${Utils.sanitize(step.instruction)}</p>
                        ${step.visual_tip ? `
                            <div class="visual-cue">
                                <span style="font-size: 1.2rem;">ğŸ‘ï¸</span>
                                <div><strong>×›××• ×‘×ª××•× ×”:</strong> ${Utils.sanitize(step.visual_tip)}</div>
                            </div>
                        ` : ''}
                        ${step.timer_seconds ? `
                            <button class="btn-primary" style="margin-top:0.5rem; font-size:0.8rem; padding: 0.3rem 0.8rem" 
                                onclick="UI.startMiniTimer(this, ${step.timer_seconds})">
                                â±ï¸ ×˜×™×™××¨ (${step.timer_seconds / 60} ×“×§')
                            </button>
                        ` : ''}
                    </div>
                `).join('');

                // Styling Guide HTML
                const stylingHtml = `
                    <div class="recipe-card" style="border-color: var(--primary-300); background: var(--primary-50);">
                        <div class="section-title">ğŸ¨ ××“×¨×™×š ×¦×™×œ×—×•×ª (Plating)</div>
                        <p style="margin-bottom: 1rem"><strong>×”×¤×™×œ×•×¡×•×¤×™×”:</strong> ${recipe.styling_guide.summary}</p>
                        <ul style="padding-right: 1.5rem;">
                            ${recipe.styling_guide.key_elements.map(el => `<li>${el}</li>`).join('')}
                        </ul>
                    </div>
                `;

                const html = `
                    <div class="recipe-header">
                        <h1 class="recipe-title">${Utils.sanitize(recipe.title)}</h1>
                        <p style="color: var(--text-muted); font-size: 1.1rem; max-width: 800px; margin: 0 auto 1rem;">${Utils.sanitize(recipe.description)}</p>
                        
                        <div class="meta-tags">
                            <div class="tag">â±ï¸ ×”×›× ×”: ${recipe.prep_time}</div>
                            <div class="tag">ğŸ³ ×‘×™×©×•×œ: ${recipe.cook_time}</div>
                            <div class="tag">ğŸ½ï¸ ×× ×•×ª: ${recipe.servings}</div>
                            <div class="tag">ğŸ“Š ×¨××”: ${recipe.difficulty}</div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-6">
                        <!-- Left Column: Ingredients -->
                        <div style="grid-column: span 1;">
                            <div class="recipe-card">
                                <div class="section-title">ğŸ›’ ××¦×¨×›×™×</div>
                                ${ingredientsHtml}
                            </div>
                            
                            <!-- Image Reference -->
                            <div class="recipe-card">
                                <div class="section-title">ğŸ“¸ ×ª××•× ×ª ××§×•×¨</div>
                                <img src="${State.currentImageBase64}" style="width:100%; border-radius: 8px; margin-bottom: 10px;">
                                <p style="font-size: 0.8rem; color: var(--text-muted)">×”×©×ª××© ×‘×ª××•× ×” ×–×• ×›×¨×¤×¨× ×¡ ×•×™×–×•××œ×™ ×œ××•×¨×š ×›×œ ×”×ª×”×œ×™×š.</p>
                            </div>
                        </div>

                        <!-- Right Column: Steps & Styling -->
                        <div style="grid-column: span 2;">
                            ${stylingHtml}
                            
                            <div class="section-title">ğŸ‘¨â€ğŸ³ ×”×•×¨××•×ª ×”×›× ×”</div>
                            ${stepsHtml}
                        </div>
                    </div>
                `;

                container.innerHTML = html;
                
                // Switch views
                Utils.$('#upload-view').classList.add('hidden');
                Utils.$('#recipe-view').classList.remove('hidden');
                window.scrollTo(0, 0);
            },

            startMiniTimer: (btn, seconds) => {
                if(btn.innerText.includes("× ×’××¨")) return;
                
                let left = seconds;
                btn.disabled = true;
                const originalText = btn.innerText;
                
                const interval = setInterval(() => {
                    left--;
                    const m = Math.floor(left / 60).toString().padStart(2, '0');
                    const s = (left % 60).toString().padStart(2, '0');
                    btn.innerText = `â±ï¸ ${m}:${s}`;
                    
                    if (left <= 0) {
                        clearInterval(interval);
                        btn.innerText = "â° ×”×–××Ÿ × ×’××¨!";
                        btn.style.backgroundColor = "#ef4444";
                        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    }
                }, 1000);
            },

            setupEventListeners: () => {
                // Drop Zone
                const dz = Utils.$('#drop-zone');
                const inp = Utils.$('#file-input');

                dz.onclick = () => inp.click();
                
                dz.ondragover = (e) => { e.preventDefault(); dz.classList.add('drag-over'); };
                dz.ondragleave = () => dz.classList.remove('drag-over');
                dz.ondrop = (e) => {
                    e.preventDefault();
                    dz.classList.remove('drag-over');
                    if(e.dataTransfer.files.length) UI.handleFileSelect(e.dataTransfer.files[0]);
                };

                inp.onchange = (e) => {
                    if(e.target.files.length) UI.handleFileSelect(e.target.files[0]);
                };

                // Options & Generation
                Utils.$('#reset-image-btn').onclick = () => {
                    Utils.$('#options-panel').classList.add('hidden');
                    Utils.$('#drop-content').classList.remove('hidden');
                    Utils.$('#image-preview').classList.add('hidden');
                    Utils.$('#image-preview').src = "";
                };

                Utils.$('#generate-btn').onclick = async () => {
                    UI.showLoader(true, '×× ×ª×— ×ª××•× ×” ×•×‘×•× ×” ××ª×›×•×Ÿ...');
                    
                    try {
                        const client = new GeminiClient();
                        const options = {
                            dietary: Utils.$('#dietary-select').value,
                            language: Utils.$('#language-select').value,
                            notes: Utils.$('#extra-notes').value
                        };

                        // Strip "data:image/jpeg;base64," header for API
                        const base64Data = State.currentImageBase64.split(',')[1];
                        
                        const recipe = await client.generateRecipe(base64Data, options);
                        State.currentRecipe = recipe;
                        
                        // Save to history
                        State.history.unshift({
                            id: Date.now(),
                            title: recipe.title,
                            date: new Date().toLocaleDateString(),
                            recipe: recipe
                        });
                        if(State.history.length > 10) State.history.pop();
                        Utils.saveLocal('recipe_history', State.history);
                        UI.renderHistory();

                        UI.renderRecipe(recipe);
                    } catch (error) {
                        alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”××ª×›×•×Ÿ: ' + error.message);
                    } finally {
                        UI.showLoader(false);
                    }
                };

                // Navigation
                Utils.$('#back-to-upload').onclick = () => {
                    Utils.$('#recipe-view').classList.add('hidden');
                    Utils.$('#upload-view').classList.remove('hidden');
                };

                // Modals
                Utils.$$('.close-modal').forEach(btn => {
                    btn.onclick = () => {
                        Utils.$('#settings-modal').classList.remove('active');
                        Utils.$('#history-modal').classList.remove('active');
                    };
                });

                Utils.$('#settings-btn').onclick = () => Utils.$('#settings-modal').classList.add('active');
                Utils.$('#history-btn').onclick = () => Utils.$('#history-modal').classList.add('active');
                
                Utils.$('#save-api-key').onclick = () => {
                    const key = Utils.$('#api-key-input').value.trim();
                    if(key) {
                        State.apiKey = key;
                        Utils.saveLocal('gemini_api_key', key);
                        Utils.$('#settings-modal').classList.remove('active');
                    }
                };

                Utils.$('#theme-toggle').onclick = UI.toggleTheme;

                // Cook Mode
                Utils.$('#start-cooking-btn').onclick = () => {
                    State.currentStepIndex = 0;
                    UI.initCookMode();
                };

                Utils.$('#speak-btn').onclick = () => {
                    const assistant = new VoiceAssistant();
                    const text = `${State.currentRecipe.title}. ${State.currentRecipe.description}. ×”××¨×›×™×‘×™× ×”×: ${State.currentRecipe.ingredients.map(i => i.item).join(', ')}`;
                    assistant.speak(text);
                };
                
                Utils.$('#print-btn').onclick = () => window.print();

                // Cook Mode Controls
                Utils.$('#exit-cook-mode').onclick = () => Utils.$('#cook-mode-view').classList.add('hidden');
                Utils.$('#next-step').onclick = () => UI.changeCookStep(1);
                Utils.$('#prev-step').onclick = () => UI.changeCookStep(-1);
                Utils.$('#cook-timer-btn').onclick = UI.toggleCookTimer;
            },

            handleFileSelect: async (file) => {
                if (!file.type.startsWith('image/')) return alert('×× × ×‘×—×¨ ×§×•×‘×¥ ×ª××•× ×”');
                
                UI.showLoader(true, '××¢×‘×“ ×ª××•× ×”...');
                try {
                    // Compress and convert to Base64
                    const dataUrl = await Utils.resizeImage(file);
                    State.currentImageBase64 = dataUrl;
                    
                    const img = Utils.$('#image-preview');
                    img.src = dataUrl;
                    img.classList.remove('hidden');
                    Utils.$('#drop-content').classList.add('hidden');
                    Utils.$('#options-panel').classList.remove('hidden');
                } catch (e) {
                    console.error(e);
                    alert('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª××•× ×”');
                } finally {
                    UI.showLoader(false);
                }
            },

            renderHistory: () => {
                const list = Utils.$('#history-list');
                list.innerHTML = '';
                State.history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'ingredient-item';
                    div.style.cursor = 'pointer';
                    div.innerHTML = `
                        <div>
                            <strong>${item.title}</strong><br>
                            <small style="color:var(--text-muted)">${item.date}</small>
                        </div>
                    `;
                    div.onclick = () => {
                        State.currentRecipe = item.recipe;
                        UI.renderRecipe(item.recipe);
                        Utils.$('#history-modal').classList.remove('active');
                    };
                    list.appendChild(div);
                });
                
                Utils.$('#clear-history').onclick = () => {
                    State.history = [];
                    Utils.saveLocal('recipe_history', []);
                    UI.renderHistory();
                };
            },

            /* --- COOK MODE LOGIC --- */
            initCookMode: () => {
                Utils.$('#cook-mode-view').classList.remove('hidden');
                UI.renderCookStep();
            },

            renderCookStep: () => {
                const steps = State.currentRecipe.steps;
                const index = State.currentStepIndex;
                const step = steps[index];
                
                const container = Utils.$('#cook-step-container');
                container.innerHTML = `
                    <div class="cook-step-large">${step.instruction}</div>
                    ${step.visual_tip ? `
                        <div style="margin-top: 2rem; padding: 1rem; background: var(--primary-50); border-radius: var(--radius-md); color: var(--primary-700);">
                            <strong>×˜×™×¤ ×œ× ×™×¨××•×ª:</strong> ${step.visual_tip}
                        </div>
                    ` : ''}
                `;

                Utils.$('#step-indicator').innerText = `×¦×¢×“ ${index + 1} ××ª×•×š ${steps.length}`;
                
                // Reset timer for step
                clearInterval(State.timerInterval);
                Utils.$('#active-timer').classList.add('hidden');
                const timerBtn = Utils.$('#cook-timer-btn');
                
                if (step.timer_seconds) {
                    timerBtn.style.display = 'inline-block';
                    timerBtn.innerText = `â±ï¸ ×”×¤×¢×œ ×˜×™×™××¨ (${step.timer_seconds / 60} ×“×§')`;
                    timerBtn.dataset.seconds = step.timer_seconds;
                } else {
                    timerBtn.style.display = 'none';
                }

                // TTS
                new VoiceAssistant().speak(step.instruction);
            },

            changeCookStep: (delta) => {
                const steps = State.currentRecipe.steps;
                const newIndex = State.currentStepIndex + delta;
                
                if (newIndex >= 0 && newIndex < steps.length) {
                    State.currentStepIndex = newIndex;
                    UI.renderCookStep();
                }
            },

            toggleCookTimer: () => {
                const display = Utils.$('#active-timer');
                const btn = Utils.$('#cook-timer-btn');
                const seconds = parseInt(btn.dataset.seconds);
                
                if (!display.classList.contains('hidden')) {
                    // Stop timer
                    clearInterval(State.timerInterval);
                    display.classList.add('hidden');
                    btn.innerText = `â±ï¸ ×”×¤×¢×œ ×˜×™×™××¨`;
                    return;
                }

                display.classList.remove('hidden');
                let left = seconds;
                
                const updateDisplay = () => {
                    const m = Math.floor(left / 60).toString().padStart(2, '0');
                    const s = (left % 60).toString().padStart(2, '0');
                    display.innerText = `${m}:${s}`;
                };
                
                updateDisplay();
                
                State.timerInterval = setInterval(() => {
                    left--;
                    updateDisplay();
                    if (left <= 0) {
                        clearInterval(State.timerInterval);
                        display.innerText = "00:00";
                        display.style.color = "red";
                        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                    }
                }, 1000);
            }
        };

        // Initialize App
        document.addEventListener('DOMContentLoaded', UI.init);

    </script>
</body>
</html>